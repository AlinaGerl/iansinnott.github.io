<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Express Basics | Ian Sinnott</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="A quick guide to using Express, and the basics of Express middleware
IntroAll source files for this article can be found in the GitHub Repo: iansinnott/express-middleware-lecture.
Outline
Intro (Simpl">
<meta property="og:type" content="article">
<meta property="og:title" content="Express Basics">
<meta property="og:url" content="https://blog.iansinnott.com/express-basics/index.html">
<meta property="og:site_name" content="Ian Sinnott">
<meta property="og:description" content="A quick guide to using Express, and the basics of Express middleware
IntroAll source files for this article can be found in the GitHub Repo: iansinnott/express-middleware-lecture.
Outline
Intro (Simpl">
<meta property="og:updated_time" content="2017-07-09T03:49:28.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Express Basics">
<meta name="twitter:description" content="A quick guide to using Express, and the basics of Express middleware
IntroAll source files for this article can be found in the GitHub Repo: iansinnott/express-middleware-lecture.
Outline
Intro (Simpl">
  
    <link rel="alternate" href="/atom.xml" title="Ian Sinnott" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/style.css">
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-52511246-1', 'auto');
  ga('send', 'pageview');

</script>


</head>
<body>
  <div
    data-event-handler='touchstart:show'
    data-target='.hidden-nav'
    id="container">
    <div id="wrap">
      <header id='header' class='outer'>
  <nav class='left-nav'>
    <a class='main-nav-link' href='/'>
      <img src='https://dropsinn.s3.amazonaws.com/face.jpg' alt='Face image' />
      Ian Sinnott
    </a>
  </nav>
  <div class='nav-menu'>
    <nav class='hidden-nav'>
      <button
        data-event-handler='touchstart:toggle,click:toggle,touchend:preventDefault'
        data-target='.hidden-nav'
        class='toggle'>
        <div class='burger'>
          <span></span>
          <span></span>
          <span></span>
        </div>
      </button>
      <a href='/'>
        <i class="fa fa-home"></i>
        Home
      </a>
      <a href='/archives'>
        <i class="fa fa-list-ul"></i>
        Archive
      </a>
      <a href='/tags'>
        <i class="fa fa-tags"></i>
        Tags
      </a>

      <hr />

      <a href="https://www.iansinnott.com/">
        <i class="fa fa-flag"></i>
        Site
      </a>
      <a href="https://twitter.com/ian_sinn">
        <i class="fa fa-twitter"></i>
        Twitter
      </a>
      <a href="https://github.com/iansinnott">
        <i class="fa fa-github"></i>
        GitHub
      </a>

      <div class='face'>
        <img src='https://dropsinn.s3.amazonaws.com/face2.jpg' alt='Hand drawn face' />
        <h3>Hello</h3>
      </div>
    </nav>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-express-basics" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/express-basics/" class="article-date">
  <time datetime="2015-02-02T08:00:00.000Z" itemprop="datePublished">2015-02-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Express Basics
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><em>A quick guide to using Express, and the basics of Express middleware</em></p>
<h2 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h2><p>All source files for this article can be found in the <a href="https://github.com/iansinnott/express-middleware-lecture" target="_blank" rel="external">GitHub Repo: iansinnott/express-middleware-lecture</a>.</p>
<h2 id="Outline"><a href="#Outline" class="headerlink" title="Outline"></a>Outline</h2><ol>
<li>Intro (Simplifying Express)</li>
<li>What is middleware?</li>
<li>The relationship between Express and middleware<ul>
<li>Explanation (it’s just a function)</li>
<li>Build a simple logger</li>
</ul>
</li>
<li>Important points about middleware<ul>
<li><strong>MUST</strong> call <code>next()</code></li>
<li>Order matters</li>
<li>Middleware can be localized to various routes</li>
</ul>
</li>
<li>Routes are also middleware</li>
<li>Handling errors<ul>
<li>404</li>
<li>Internal server error (500)</li>
</ul>
</li>
<li>Conclusion<ul>
<li><strong>Express is just a stack of middleware</strong></li>
<li>Common and useful middleware you will undoubtedly see</li>
<li>More resources</li>
</ul>
</li>
</ol>
<h2 id="Simplifying-Express"><a href="#Simplifying-Express" class="headerlink" title="Simplifying Express"></a>Simplifying Express</h2><p>So first things first, rather than starting with everything and figuring out what it all does, let’s start with a base Express configuration and add things as we need them.</p>
<p>A standard Express app configuration using the <code>express-generator</code> NPM module will produce something like this:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> favicon = <span class="built_in">require</span>(<span class="string">'serve-favicon'</span>);</div><div class="line"><span class="keyword">var</span> logger = <span class="built_in">require</span>(<span class="string">'morgan'</span>);</div><div class="line"><span class="keyword">var</span> cookieParser = <span class="built_in">require</span>(<span class="string">'cookie-parser'</span>);</div><div class="line"><span class="keyword">var</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> routes = <span class="built_in">require</span>(<span class="string">'./routes/index'</span>);</div><div class="line"><span class="keyword">var</span> users = <span class="built_in">require</span>(<span class="string">'./routes/users'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line"></div><div class="line"><span class="comment">// view engine setup</span></div><div class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</div><div class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'jade'</span>);</div><div class="line"></div><div class="line"><span class="comment">// uncomment after placing your favicon in /public</span></div><div class="line"><span class="comment">//app.use(favicon(__dirname + '/public/favicon.ico'));</span></div><div class="line">app.use(logger(<span class="string">'dev'</span>));</div><div class="line">app.use(bodyParser.json());</div><div class="line">app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</div><div class="line">app.use(cookieParser());</div><div class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</div><div class="line"></div><div class="line">app.use(<span class="string">'/'</span>, routes);</div><div class="line">app.use(<span class="string">'/users'</span>, users);</div><div class="line"></div><div class="line"><span class="comment">// catch 404 and forward to error handler</span></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> err = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Not Found'</span>);</div><div class="line">  err.status = <span class="number">404</span>;</div><div class="line">  next(err);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// error handlers</span></div><div class="line"><span class="keyword">if</span> (app.get(<span class="string">'env'</span>) === <span class="string">'development'</span>) &#123;</div><div class="line">  app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</div><div class="line">    res.status(err.status || <span class="number">500</span>);</div><div class="line">    res.render(<span class="string">'error'</span>, &#123;</div><div class="line">      <span class="attr">message</span>: err.message,</div><div class="line">      <span class="attr">error</span>: err</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</div><div class="line">  res.status(err.status || <span class="number">500</span>);</div><div class="line">  res.render(<span class="string">'error'</span>, &#123;</div><div class="line">    <span class="attr">message</span>: err.message,</div><div class="line">    <span class="attr">error</span>: &#123;&#125;</div><div class="line">  &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = app;</div></pre></td></tr></table></figure>
<p>There’s a lot going on there, and for anyone without experience using Express that may look daunting if all we really want is a super simple application.</p>
<h3 id="Simplify-all-of-the-things"><a href="#Simplify-all-of-the-things" class="headerlink" title="Simplify all of the things!"></a>Simplify all of the things!</h3><p>The above configuration file also makes assumptions about what you will need in your project. This can be useful but it is quite detrimental to learning the ins and outs of Express, because it does too much automatically. Let’s start from a bare-bones Express app and expand as needed. Here’s our configuration file:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line"></div><div class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">  res.send(<span class="string">"hello express"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">app.listen(<span class="number">3000</span>);</div></pre></td></tr></table></figure>
<p>This file will responds to GET requests at <code>/</code>—the root URL. Any other requests will cause an Express error, because there is no request handler for any other route or method.</p>
<p>If you open your browser and go to <a href="http://localhost:3000" target="_blank" rel="external">localhost:3000</a> you should see the text “hello express”, or you could use CURL:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ curl :3000</div><div class="line">hello express</div></pre></td></tr></table></figure>
<p>Now that we have a super simple Express app up and running, let’s move on to middleware.</p>
<h2 id="Middleware"><a href="#Middleware" class="headerlink" title="Middleware"></a>Middleware</h2><p>Middleware, in the context of Express is just a fancy term for a function that gets run on your server <em>after</em> a request has been received from a client and <em>before</em> a response is sent back. In other words, it’s a function that gets run <strong>in the middle</strong> of the requeset-response cycle.</p>
<p>So what does that look like in practice? Let’s take a look:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Define your middleware</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">uselessMiddleware</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="comment">// Do some stuff...</span></div><div class="line">  next();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// "Use" your middlware</span></div><div class="line">app.use(uselessMiddleware);</div></pre></td></tr></table></figure>
<p>The above function (middleware) is in fact useless as implied by its name because it doesn’t do anything at all. It simply calls the next middleware in the middleware stack (more on that below).</p>
<p>When writing simple middleware, we often use an anonymous function, so let’s refactor the above as so:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="comment">// Do some stuff...</span></div><div class="line">  next();</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Now let’s make our middleware do something.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'hey nice middleware'</span>);</div><div class="line">  next();</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>This middleware is simply going to log a string to the console. To make sure it’s working, and to see how middleware works, let’s send a request to our server. Use either your browser or CURL from the command line:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ curl :3000</div><div class="line">hello express</div></pre></td></tr></table></figure>
<p>Regardless of how you made the requeset, if you now look in your terminal you should see that our middleware was indeed run because “hey nice middleware” will have been printed to the command line.</p>
<h2 id="Express-and-Middleware"><a href="#Express-and-Middleware" class="headerlink" title="Express and Middleware"></a>Express and Middleware</h2><p>The one thing I want you to take away from this lecture is that <strong>an Express app is simply a stack of middleware</strong>. In other words, as the Express website says:</p>
<blockquote>
<p>An Express application is essentially a series of middleware calls.</p>
</blockquote>
<p>To see how true this is, let’s look at a standard Express route:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">app.get(<span class="string">'/hello'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">  res.send(<span class="string">'Hello route'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>This is a super simple Express route that will respond to a GET request at <code>/hello</code> with the text string “hello route”.</p>
<p>But what if we want some bit of code to be run on <em>all</em> requests instead of just GET requests to <code>/hello</code>? For instance, what if we wanted to implement our own logger that would log the method and path of every request to the command line? That’s where middleware comes in.</p>
<p>When we call <code>app.use</code> we are saying, “Every time a new request comes in run this function.”</p>
<h3 id="Building-a-simple-logger"><a href="#Building-a-simple-logger" class="headerlink" title="Building a simple logger"></a>Building a simple logger</h3><p>To see this in action let’s built a simple logger that will output strings of the form:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">[METHOD] [ROUTE] [DATE]</div></pre></td></tr></table></figure>
<p>Example:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">GET / Sun Jan 25 2015 22:27:07 GMT-0800 (PST)</div><div class="line">GET /some-route Sun Jan 25 2015 22:27:07 GMT-0800 (PST)</div><div class="line">POST /contact Sun Jan 25 2015 22:27:07 GMT-0800 (PST)</div></pre></td></tr></table></figure>
<p>Using express middleware, we can accomplish this pretty easily:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>();</div><div class="line">  <span class="built_in">console</span>.log(req.method + <span class="string">' '</span> + req.url + <span class="string">' '</span> + date);</div><div class="line">  next();</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Now in just five lines of code we’ve created a rudimentary logging system.</p>
<h2 id="Important-points-about-middleware"><a href="#Important-points-about-middleware" class="headerlink" title="Important points about middleware"></a>Important points about middleware</h2><p>Middleware is super flexible and easy to use, but there are still a few important points that need to be noted.</p>
<h3 id="Always-call-next"><a href="#Always-call-next" class="headerlink" title="Always call next"></a>Always call <code>next</code></h3><p>As you’ve seen in all the middleware examples so far, I make sure to call <code>next</code> at the end of the function. What would happen if we didn’t call next? Try it out. Remove next from our logging middleware above and run the app. Here’s the full source code for <code>app.js</code>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line"></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>();</div><div class="line">  <span class="built_in">console</span>.log(req.method + <span class="string">' '</span> + req.url + <span class="string">' '</span> + date);</div><div class="line">  <span class="comment">// WE DIDN'T CALL `next` HERE!!</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">  res.send(<span class="string">"hello express"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">app.listen(<span class="number">3000</span>);</div></pre></td></tr></table></figure>
<p>Run the app, then make a request:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">node app.js</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">curl :3000</div></pre></td></tr></table></figure>
<p>Now your terminal will just sort of hang and do nothing. You will also see that the logging function was still run, because there will be a log entry in the terminal. This is because your app (<code>app.js</code>) received a request, called the logging middleware, logged the output and then… did nothing. The app is waiting for us to either send a response back to the client or call <code>next</code>. Since we didn’t do either, it just hangs until we hit ctrl-c to stop our server.</p>
<p>So the point is, always call <code>next</code>, otherwise you’re server will not only not respond but also not give you an error. It will simply do nothing, and leave the browser waiting for a response.</p>
<h3 id="Order-Matters"><a href="#Order-Matters" class="headerlink" title="Order Matters"></a>Order Matters</h3><p>As the <a href="http://expressjs.com/guide/using-middleware.html" target="_blank" rel="external">documentation says</a>:</p>
<blockquote>
<p>Middleware functions are executed sequentially, therefore the order of middleware inclusion is important.</p>
</blockquote>
<p>This is nothing overly complex, but it’s important to be aware of. Here’s a quick example, again using our logging middleware from above:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line"></div><div class="line"><span class="comment">// Route</span></div><div class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">  res.send(<span class="string">"hello express"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// Logging middleware added after route</span></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>();</div><div class="line">  <span class="built_in">console</span>.log(req.method + <span class="string">' '</span> + req.url + <span class="string">' '</span> + date);</div><div class="line">  next();</div><div class="line">&#125;);</div><div class="line"></div><div class="line">app.listen(<span class="number">3000</span>);</div></pre></td></tr></table></figure>
<p>As before, run the app and send a request to the root URL at <a href="http://localhost:3000" target="_blank" rel="external">localhost:3000</a>. The request that comes back from the server will have the text “hello express” as expected, but if you look at the console you will notice that our middleware did not run. This is because we added it <em>after</em> our route.</p>
<p><strong>What happened?</strong></p>
<p>Even though we added the logging middleware <em>after</em> the route, you might think it should still get run after our route is hit, but that’s not the case. Calling <code>res.send</code> actually ends the request-response cycle, because it sends a response to the client. After the req-res cycle has ended, no more middleware will be called, so our logging middleware never gets executed.</p>
<h3 id="Middleware-can-be-localized-to-routes"><a href="#Middleware-can-be-localized-to-routes" class="headerlink" title="Middleware can be localized to routes"></a>Middleware can be localized to routes</h3><p>Global middleware is really useful, but sometimes it would be unecessary to run certain middleware for <em>all</em> routes and methods. That’s why Express let’s you pass an optional string as the initial argument to <code>app.use</code>. Imagine we have an admin area on our website at <code>/admin</code>. We want to check to make sure a user is logged in before they access the page. A simple way to accomplish this would be:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">app.use(<span class="string">'/admin'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (!req.user)</div><div class="line">    res.redirect(<span class="string">'/login'</span>);</div><div class="line">  <span class="keyword">else</span></div><div class="line">    next();</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>This example assumes that <code>req.user</code> will be set if the user is already logged in, as is the case when using <a href="http://passportjs.org/" target="_blank" rel="external">Passport JS</a>. If there is no user present on the request then the browser will be redirected to login. If there is a user however then the middleware simply calls next and allows the process to continue as normal.</p>
<h2 id="Routes-are-just-more-middleware"><a href="#Routes-are-just-more-middleware" class="headerlink" title="Routes are just more middleware"></a>Routes are just more middleware</h2><p>Usually when we talk about Express we talk about routes and middleware as separate, because conceptually they are. A “route” typically means the end of the middleware stack, the last response handler that is called and that decides ultimately how to respond to the request. However, to understand Express it’s important to understand that routes themselves are also “middleware”—simply functions that get called under certain circumstances.</p>
<p>As an example, take a look at these two completely equivalent “routes”. One is written as you would normally write a route, using <code>app.get</code> while the other is written as middleware, but the effect is exactly the same:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">  res.send(<span class="string">'hello express'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">app.use(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (req.method === <span class="string">'GET'</span>)</div><div class="line">    res.send(<span class="string">'hello express'</span>);</div><div class="line">  <span class="keyword">else</span></div><div class="line">    next();</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Using middlware syntax and manually checking the request method is of course more verbose, and certainly not what you want to do in practice. But it’s important to realize that Express routes and Express middleware ware actually on in the same. This is why, as mentioned in the docs and above…</p>
<blockquote>
<p>An Express application is essentially a series of middleware calls.</p>
</blockquote>
<h2 id="Error-Handling"><a href="#Error-Handling" class="headerlink" title="Error Handling"></a>Error Handling</h2><p>Until you are comfortable with Express as a “stack” of middleware that get called in the order they were added, it may not be obvious how errors are normally handled. There is no <code>app.error</code> method. The way errors are handled is again, through middleware:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// The rest of the app...</span></div><div class="line"></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.status(<span class="number">404</span>).send(<span class="string">"Oh no, there was an error..."</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>This middleware matches any route and any method, and all it does is send an error message to the browser. If you added this at the top of all your middleware your site would continually send this error message to the client. However, by putting this at the very end of our app configuration we can allow all routes that weren’t matched by previous middleware to effectively fall through and be caught here.</p>
<p>However, since not every error is a 404, it’s important to allow for other errors with other status codes. To accomplish this, Express recognizes middleware with four arguments instead of three as being an error handler.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</div><div class="line">  res.status(err.status || <span class="number">500</span>);</div><div class="line">  res.send(<span class="string">"Oh no, there was an error..."</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>In the eyes of Express, this middleware is clearly an error handler because it expects four arguments, the first of which is an error object. <strong>Note:</strong> If you don’t manually set a status code 200 will still be the default, which would of course be incorrect for responding with an error. If there is no status set on the <code>err</code> object then we default to the generic 500 status code.</p>
<p>So, now we have an error handler but if you restart your server and navigate to a URL that we know there’s no router for (ex: “/something”) you will get a standard Express error, <em>NOT</em> the custom error we just created. What happened?</p>
<p>Since we aren’t using any third party middleware yet, we know every piece of code that’s being executed when a request hits the server. As a result, we can see that at no point is an error generated. This is crucial, because errors in Express are not automatic. JavaScript errors will happily bring down your server, but if you want to handle them with easy you will need to manually call the <code>next</code> function and pass an error argument. That will let Express execute our custom error handling code as scene above. So, to make sure all 404’s do indeed generate an error, we can add a catch-all middleware right above our error handler:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> err = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Page not found!"</span>);</div><div class="line">  err.status = <span class="number">404</span>;</div><div class="line">  next(err); <span class="comment">// Call `next` with an argument</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</div><div class="line">  res.status(err.status || <span class="number">500</span>);</div><div class="line">  res.send(<span class="string">"Oh no, there was an error..."</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Now if we restart our server we will get the result we want: All errors, 404 or otherwise, will be directed to our final error handler and we will get a response containing the string “Oh no, there was an error…”.</p>
<h3 id="A-quick-note-on-triggering-errors"><a href="#A-quick-note-on-triggering-errors" class="headerlink" title="A quick note on triggering errors"></a>A quick note on triggering errors</h3><p>In the example above we called <code>next</code> with a single <code>Error</code> object as the lone argument. To generate an Express error and jump directly to error handling middleware you need only call <code>next</code> with a truthy argument. For example:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">// All of these would trigger error handling middleware</span></div><div class="line">  next(<span class="string">'hey there'</span>);</div><div class="line">  next(<span class="number">40</span>);</div><div class="line">  next(<span class="literal">true</span>);</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>The only exception to the above is calling <code>next(&#39;route&#39;)</code>. Calling <code>next</code> with the special string <code>&#39;route&#39;</code> will not cause an error. See <a href="http://expressjs.com/4x/api.html#app.METHOD" target="_blank" rel="external">the docs here for more on this</a>.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>So, once again to reiterate:</p>
<blockquote>
<p>An Express application is essentially a series of middleware calls.</p>
</blockquote>
<p>If you remember one thing from this lecture remember that, because it will give you a clear understanding of how Express works and more importantly how to extend it to suite your needs.</p>
<p>That being said, there is currently a plethora of useful middleware in the wild that you will most likely encounter at one point or another if you stick with Express.</p>
<h3 id="Useful-amp-Common-Middleware"><a href="#Useful-amp-Common-Middleware" class="headerlink" title="Useful &amp; Common Middleware"></a>Useful &amp; Common Middleware</h3><p><strong><a href="https://github.com/expressjs/body-parser" target="_blank" rel="external">Body Parser</a></strong></p>
<p>This is one you’re almost certain to see in most Express apps, as it’s useful for handling forms as well as AJAX requests.</p>
<p><strong><a href="https://github.com/expressjs/body-parser" target="_blank" rel="external">Serve Static</a></strong></p>
<p>This one makes it easy to statically serve a directory. For example, if you have a <code>/public</code> and you would like to put all your static files there (images, css, scripts) then you would want to use the static middleware to field requests for all resources under public. This is so common that the serve-static middleware is actually bundled with Express:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">app.use(express.static(__dirname + <span class="string">'/public'</span>)));</div></pre></td></tr></table></figure>
<p><strong><a href="https://github.com/expressjs/morgan" target="_blank" rel="external">Morgan</a></strong></p>
<p>This is flexible logging software that can be used in development or production. Even though as we saw it’s quite simple to write your own logging software, it’s a better idea to use something standard like Morgan because you can be sure your logs will be well formatted, and it’s also one lest thing for you to test.</p>
<p>There’s a ton of middleware out there, so whenever you run into a feature that Express doesn’t have but you would like chances are there’s a middleware module for it.</p>
<h3 id="Resource-Links"><a href="#Resource-Links" class="headerlink" title="Resource Links"></a>Resource Links</h3><ul>
<li><a href="http://expressjs.com/guide/using-middleware.html" target="_blank" rel="external">Official Express Middleware Guide</a></li>
<li><a href="http://expressjs.com/api.html#app.use" target="_blank" rel="external">Official app.use API documentation</a></li>
</ul>
<h2 id="Outro"><a href="#Outro" class="headerlink" title="Outro"></a>Outro</h2><p>As I mentioned in the intro, this guide and all JS source files can be found in the repo on GitHub: <a href="https://github.com/iansinnott/express-middleware-lecture" target="_blank" rel="external">iansinnott/express-middleware-lecture</a>.</p>
<p>This write-up was the content of an interview and guest lecture I had at <a href="http://www.makersquare.com/" target="_blank" rel="external">Makersquare</a>, a JavaScript bootcamp in San Francisco. The Markdown file for the presentation I gave <a href="https://github.com/iansinnott/express-middleware-lecture/blob/master/presentation.md" target="_blank" rel="external">can be found here</a>. The presentation was created for use with <a href="http://decksetapp.com/" target="_blank" rel="external">Deckset</a>, a Mac application for creating slideshows with Markdown.</p>

      
    </div>
    <footer class="article-footer">
      <div class='share-menu'>
        <button class="article-share-link share-toggle">
          Share
        </button>
        <div class='share-box'>
          <input
            type='text'
            class='article-share-input'
            onfocus='this.setSelectionRange(0, this.value.length);'
            value='https://blog.iansinnott.com/express-basics/' />
          <nav class='share-links'>
            
            <a
              href='https://twitter.com/intent/tweet?url=https%3A%2F%2Fblog.iansinnott.com%2Fexpress-basics%2F'
              target='_blank'
              class="share-link share-twitter"></a>
            <a
              href='https://www.facebook.com/sharer.php?u=https%3A%2F%2Fblog.iansinnott.com%2Fexpress-basics%2F'
              target='_blank'
              class="share-link share-facebook"></a>
            <a
              href='https://plus.google.com/share?url=https%3A%2F%2Fblog.iansinnott.com%2Fexpress-basics%2F'
              target='_blank'
              class="share-link share-google"></a>
          </nav>
        </div>
      </div>
      
        <a href="https://blog.iansinnott.com/express-basics/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/express/">express</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/middleware/">middleware</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tutorial/">tutorial</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/a-new-direction/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          A New Direction
        
      </div>
    </a>
  
  
    <a href="/use-redcarpet-to-render-markdown/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Use RedCarpet to Render Markdown</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
      </div>
    </div>

    <footer id="footer">
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Ian Sinnott<br>
    </div>
  </div>
</footer>


    
    
    <script>
      var disqus_shortname = 'iansinnott';
      
      var disqus_url = 'https://blog.iansinnott.com/express-basics/';
      
      (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    

    <script src="/js/main.js"></script>
  </div>
</body>
</html>
